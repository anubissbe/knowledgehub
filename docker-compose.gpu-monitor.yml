# GPU Monitoring service for KnowledgeHub

services:
  # GPU Monitor - Continuous GPU monitoring and metrics
  gpu-monitor:
    image: python:3.11-slim
    container_name: knowledgehub-gpu-monitor
    command: >
      bash -c "
      apt-get update && apt-get install -y curl procps &&
      while true; do
        echo '{\"timestamp\": \"'$$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'\", \"level\": \"INFO\", \"service\": \"gpu-monitor\", \"message\": \"GPU monitoring cycle started\"}';
        python3 /app/gpu_monitor_simple.py 2>&1 | while read line; do
          echo '{\"timestamp\": \"'$$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'\", \"level\": \"INFO\", \"service\": \"gpu-monitor\", \"message\": \"'$$line'\"}';
        done;
        sleep 300;
      done
      "
    volumes:
      - /opt/projects/knowledgehub/gpu_monitor_simple.py:/app/gpu_monitor_simple.py:ro
      - /usr/bin/nvidia-smi:/usr/bin/nvidia-smi:ro
      - /tmp:/tmp
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=gpu-monitor,component=knowledgehub"

networks:
  default:
    external: true
    name: knowledgehub_default